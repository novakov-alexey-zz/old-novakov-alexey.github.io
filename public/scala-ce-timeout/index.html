<!DOCTYPE html>
<html lang="en">
    <head>
      
        <meta http-equiv="X-UA-Compatible" content="IE=edge" >
        <meta http-equiv="content-type" content="text/html; charset=utf-8">   
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@alexey_novakov">
        <meta name="twitter:creator" content="@alexey_novakov">
        <meta name="twitter:url" content="https://novakov-alexey.github.io">
        <meta name="twitter:title" content="SE Notes - Alexey Novakov">
        <meta name="twitter:description" content="Software Engineering notes on Scala, JVM, Rust, Cloud and other goodies">
        <meta name="twitter:image" content="https://novakov-alexey.github.io/img/alexey_white2.jpg">
        <meta name="twitter:image:alt" content="Alexey Novakov photo for personal web-site">

        <!-- SEO -->
        
        <title> Cats-Effect: Cancel Scala Process on Timeout | Software Engineering Notes </title>
        

        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport"  content="width=device-width, initial-scale=1.0, maximum-scale=1" >

        <!--  css -->
        <link rel="stylesheet"  href="http:&#x2F;&#x2F;127.0.0.1:1111/ergo.css" >

        <!-- fonts -->
        <!-- preload  -->
        <link rel="preload" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway" as="style">
        <link rel="preload"  href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" as="style" >
        <!-- load -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"  integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
      
    </head>

    <body>
      
        
<input type="checkbox" id="openSidebarMenu" class="openSidebarMenu">
<label class="menu cross menu--1" for="openSidebarMenu">
    <svg viewBox="0 0 75 75" xmlns="https://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="30" />
        <path class="line--1" d="M0 40h62c13 0 6 28-4 18L35 35" />
        <path class="line--2" d="M0 50h70" />
        <path class="line--3" d="M0 60h62c13 0 6-28-4-18L35 65" />
    </svg>
</label>

<div id="sidebarMenu">
    <div class="menu_wrapper">
        <ul class="sidebarMenuInner" >     
            <li>
                <a href="http:&#x2F;&#x2F;127.0.0.1:1111" >Software Engineering Notes</a>
                <div class="menu_div" ></div>
            </li>                   
            <li><a href="http:&#x2F;&#x2F;127.0.0.1:1111/cv/">CV</a></li>
            <li><a href="http:&#x2F;&#x2F;127.0.0.1:1111/presentations">Presentations</a></li>
            <li><a href="http:&#x2F;&#x2F;127.0.0.1:1111/categories">Categories</a></li>
            <li><a href="http:&#x2F;&#x2F;127.0.0.1:1111/tags">Tags</a></li>
        </ul>
    </div>
</div>

      

      
<nav id="overlord" class="overlord" >
  
<figure class="mini_logo ">
    <a href="http:&#x2F;&#x2F;127.0.0.1:1111" style="background-image: url(http:&#x2F;&#x2F;127.0.0.1:1111/img/alexey_white2.jpg)"></a>
</figure>
<h5>
    <a href="http:&#x2F;&#x2F;127.0.0.1:1111">Software Engineering Notes</a>
</h5>

</nav>

<section class="post_container">
  <article>
    
      <h1 class="article_title"><a href="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;scala-ce-timeout&#x2F;" id="article_link">Cats-Effect: Cancel Scala Process on Timeout</a></h1>
      
<ul class="frontmatter frontmatter_page" id="frontmatter">
    <li>
        <time class="article_time"  datetime="2020-02-29">February 29, 2020</time>
    </li>
    <span class="dotDivider"></span>
    <li> 733 words </li>
    <span class="dotDivider" ></span>
    <li> 4 min </li>
</ul>

      <img src="http:&#x2F;&#x2F;127.0.0.1:1111&#x2F;processed_images&#x2F;a64f6fb820556b3000.jpg" />
<ul id="frontmatter" class="frontmatter frontmatter_page"><li>Photo by Maico Amorim on Unsplash</li></ul>
<p>Sometimes Scala developer needs to call external program, which is running outside of the JVM. 
In this case, we use <code>scala.sys.process</code> package. Process package has bunch of functions to spin up new processes, 
consume their outputs and errors. Also, spawned process can be stopped. Usually, we run external programs for a short period
of time to make some side-effect. Then, we analyse its exit code to apply some error handling logic in our main Scala program.
It worth to say that process API is blocking execution thread, when we are waiting for its completion. To summarise, Scala
developer wants to do the following:</p>
<ol>
<li>Start external program as a process by giving a string containing command to be executed in underlying operating system.</li>
<li>Wait for completion and get the exit code.</li>
<li>Cancel spawned process, in case waiting time for its completion is greater than a certain threshold.</li>
</ol>
<p>Good news, we can do all of that in Cats-Effect leveraging IO monad to handle a side-effect and having timeout logic around.</p>
<h2 id="handle-blocking-code">Handle blocking code</h2>
<p>Besides usual <code>ContextShift</code>, we will use separate thread pool to run blocking code of process API.
Cats-Effect provides <code>Blocker</code> class to evaluate specific IO on a given execution context. In case below, we are going
to use CachedThreadPool, which can grow almost infinitely. Our main execution context will be still <code>ExecutionContext.global</code>
and it will be used for non-blocking operations.</p>
<pre style="background-color:#282a36;">
<span style="color:#f8f8f2;">
</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">java.util.concurrent.Executors
</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">java.util.concurrent.TimeoutException

</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">cats.effect.ExitCase.</span><span style="color:#bd93f9;">_
</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">cats.effect.{Blocker, Concurrent, ContextShift, IO, Timer}
</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">cats.implicits.</span><span style="color:#bd93f9;">_

</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">scala.concurrent.ExecutionContext
</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">scala.concurrent.duration.</span><span style="color:#bd93f9;">_
</span><span style="color:#ff79c6;">import </span><span style="color:#f8f8f2;">scala.sys.process.</span><span style="color:#bd93f9;">_

</span><span style="color:#ff79c6;">implicit </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">timer: </span><span style="font-style:italic;color:#66d9ef;">Timer</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">IO</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= </span><span style="color:#6be5fd;">IO</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">timer(</span><span style="color:#6be5fd;">ExecutionContext</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">global)
</span><span style="color:#ff79c6;">implicit </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">cs: </span><span style="font-style:italic;color:#66d9ef;">ContextShift</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">IO</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= </span><span style="color:#6be5fd;">IO</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">contextShift(</span><span style="color:#6be5fd;">ExecutionContext</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">global)

</span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">cachedThreadPool </span><span style="color:#ff79c6;">= </span><span style="color:#6be5fd;">Executors</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">newCachedThreadPool()
</span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">blocker </span><span style="color:#ff79c6;">= </span><span style="color:#6be5fd;">Blocker</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">liftExecutionContext(
    </span><span style="color:#6be5fd;">ExecutionContext</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">fromExecutor(cachedThreadPool)
)

</span></pre><h2 id="blocking-task">Blocking Task</h2>
<p><code>Blocker</code> has <code>blockOn</code> method, which takes an IO and returns an IO to be evaluated on the specified earlier thread pool.</p>
<pre style="background-color:#282a36;">
<span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">startProcess</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">cmd</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">): </span><span style="font-style:italic;color:#66d9ef;">IO</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#8be9fd;">Int</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">{
  </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">blockingTask </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;"> blocker</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">blockOn(</span><span style="color:#6be5fd;">IO</span><span style="color:#f8f8f2;">(cmd</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">run()))

  </span><span style="color:#6272a4;">//.... tbd
</span><span style="color:#ffffff;">}

</span></pre>
<p>Using Cats-Effect <a href="https://typelevel.org/cats-effect/typeclasses/bracket.html">Bracket</a> type class we can safely start our
process and handle its IO cancelation. On task cancel event, we are going to call <code>Process#destroy</code> method to stop running in OS.</p>
<pre style="background-color:#282a36;">
<span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">startProcess</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">cmd</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">): </span><span style="font-style:italic;color:#66d9ef;">IO</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#8be9fd;">Int</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">{
  </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">blockingTask </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;"> blocker</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">blockOn(</span><span style="color:#6be5fd;">IO</span><span style="color:#f8f8f2;">(cmd</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">run()))
  blockingTask</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">bracketCase </span><span style="color:#ffffff;">{ </span><span style="font-style:italic;color:#ffb86c;">p </span><span style="font-style:italic;color:#8be9fd;">=&gt;
    </span><span style="color:#6be5fd;">IO</span><span style="color:#f8f8f2;">(p</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">exitValue())
  </span><span style="color:#ffffff;">} {</span><span style="color:#f8f8f2;"> (</span><span style="font-style:italic;color:#ffb86c;">p</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#ffb86c;">exit</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;">
    exit </span><span style="color:#ff79c6;">match </span><span style="color:#ffffff;">{
      </span><span style="color:#ff79c6;">case </span><span style="color:#6be5fd;">Completed </span><span style="color:#ff79c6;">=&gt; </span><span style="color:#6be5fd;">IO</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">unit
      </span><span style="color:#ff79c6;">case </span><span style="color:#6be5fd;">Error</span><span style="color:#f8f8f2;">(</span><span style="color:#bd93f9;">_</span><span style="color:#f8f8f2;">) | </span><span style="color:#6be5fd;">Canceled </span><span style="color:#ff79c6;">=&gt; </span><span style="color:#6be5fd;">IO</span><span style="color:#f8f8f2;">(p</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">destroy())
    </span><span style="color:#ffffff;">}
  }
} 
</span></pre>
<p>Above pattern matching case on Canceled, we stop process <code>p</code> using <code>destroy()</code>.</p>
<h2 id="run-a-task-with-timeout">Run a task with timeout</h2>
<p>One of the way to run Cats IO with timeout is to use its <code>race</code> method from <code>Concurrent</code> type class. Second
task in race is a call of <code>Timer#sleep</code>, which is semantically blocking an IO for a specified duration.</p>
<p>Let's bring special function to start a race for two IOs and have third task as fallback IO, in case first IO
was not completed before timeout. Below function was reused from Cats-Effect documentation:</p>
<pre style="background-color:#282a36;">
<span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">timeoutTo</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">F</span><span style="color:#f8f8f2;">[_], </span><span style="font-style:italic;color:#66d9ef;">A</span><span style="color:#f8f8f2;">](
    </span><span style="font-style:italic;color:#ffb86c;">fa</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">F</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">A</span><span style="color:#f8f8f2;">],
    </span><span style="font-style:italic;color:#ffb86c;">after</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">FiniteDuration</span><span style="color:#f8f8f2;">,
    </span><span style="font-style:italic;color:#ffb86c;">fallback</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">F</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">A</span><span style="color:#f8f8f2;">]
  )(</span><span style="color:#ff79c6;">implicit </span><span style="font-style:italic;color:#ffb86c;">timer</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">Timer</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">F</span><span style="color:#f8f8f2;">], </span><span style="font-style:italic;color:#ffb86c;">concurrent</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">Concurrent</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">F</span><span style="color:#f8f8f2;">]): </span><span style="font-style:italic;color:#66d9ef;">F</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">A</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">{</span><span style="color:#f8f8f2;">

    concurrent</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">race(fa, timer</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">sleep(after))</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">flatMap </span><span style="color:#ffffff;">{
      </span><span style="color:#ff79c6;">case </span><span style="color:#6be5fd;">Left</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">a</span><span style="color:#f8f8f2;">) </span><span style="color:#ff79c6;">=&gt;</span><span style="color:#f8f8f2;">
        println(</span><span style="color:#f1fa8c;">&quot;Done&quot;</span><span style="color:#f8f8f2;">)
        concurrent</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">pure(a)
      </span><span style="color:#ff79c6;">case </span><span style="color:#6be5fd;">Right</span><span style="color:#f8f8f2;">(</span><span style="color:#bd93f9;">_</span><span style="color:#f8f8f2;">) </span><span style="color:#ff79c6;">=&gt;</span><span style="color:#f8f8f2;">
        println(</span><span style="color:#f1fa8c;">&quot;Timeout&quot;</span><span style="color:#f8f8f2;">)
        fallback
    </span><span style="color:#ffffff;">}
  }
</span></pre>
<p>Now we are ready to run our blocking task with timeout. For the sake of example, we set 1 second as timeout and failing returned IO,
by giving fallback IO with exception. Let us run infinitely running command such <code>tail -f</code> on some file to simulate 
long-running task, which we need to cancel in case of timeout.</p>
<pre style="background-color:#282a36;">
<span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">task </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;"> startProcess(</span><span style="color:#f1fa8c;">&quot;tail -f build.sbt&quot;</span><span style="color:#f8f8f2;">)
</span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">finalTask </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;"> timeoutTo(task, </span><span style="color:#bd93f9;">1</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">second, 
  </span><span style="color:#6be5fd;">IO</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">raiseError(</span><span style="color:#ff79c6;">new </span><span style="font-style:italic;color:#66d9ef;">TimeoutException</span><span style="color:#f8f8f2;">(</span><span style="color:#f1fa8c;">&quot;Failed to run external process&quot;</span><span style="color:#f8f8f2;">)))
finalTask</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">unsafeRunSync()
</span></pre>
<p>Output</p>
<pre style="background-color:#282a36;">
<span style="color:#f8f8f2;">scala&gt; finalTask</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">unsafeRunSync()
          </span><span style="color:#6272a4;">//... here comes a content of build.sbt as per given command 
  
</span><span style="color:#6be5fd;">Timeout</span><span style="color:#f8f8f2;">
java</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">util</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">concurrent</span><span style="color:#ff79c6;">.</span><span style="color:#6be5fd;">TimeoutException</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">Failed to run external process
</span></pre>
<p>Happy case:</p>
<pre style="background-color:#282a36;">
<span style="color:#f8f8f2;">scala&gt; </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">task </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;"> startProcess(</span><span style="color:#f1fa8c;">&quot;echo cats&quot;</span><span style="color:#f8f8f2;">)
scala&gt; </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#f8f8f2;">finalTask </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;"> timeoutTo(task, </span><span style="color:#bd93f9;">1</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">second, 
  </span><span style="color:#6be5fd;">IO</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">raiseError(</span><span style="color:#ff79c6;">new </span><span style="font-style:italic;color:#66d9ef;">TimeoutException</span><span style="color:#f8f8f2;">(</span><span style="color:#f1fa8c;">&quot;Failed to run externall process&quot;</span><span style="color:#f8f8f2;">)))
scala&gt; finalTask</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">unsafeRunSync()
cats
</span><span style="color:#6be5fd;">Done</span><span style="color:#f8f8f2;">
res3: </span><span style="font-style:italic;color:#8be9fd;">Int </span><span style="color:#ff79c6;">= </span><span style="color:#bd93f9;">0
</span></pre><h2 id="summary">Summary</h2>
<ul>
<li>Using <code>Bracket</code> we can easily catch IO cancelation and release acquired resource. 
In the example above, we destroy external process, so that OS resource is released. </li>
<li>Cats <code>Blocker</code> helps us to run blocking tasks safely with regards
to other non-blocking tasks. </li>
<li>And <code>IO.race</code> can be used to simulate timeout, since it cancels race looser.</li>
</ul>

      
  </article>
</section>

       

      <footer>
        
          
<figure class="mini_logo ">
    <a href="http:&#x2F;&#x2F;127.0.0.1:1111" style="background-image: url(http:&#x2F;&#x2F;127.0.0.1:1111/img/alexey_white2.jpg)"></a>
</figure>
<h5>
    <a href="http:&#x2F;&#x2F;127.0.0.1:1111">Software Engineering Notes</a>
</h5>

          
<ul class="social_list foot_list" >
    
    
    <li class="button extra_small font_faint"><a href="https://github.com/novakov-alexey" target="_blank" >novakov-alexey</a><i class="fab fa-github" ></i></li>
    
    
    <li class="button extra_small font_faint"><a href="https://twitter.com/alexey_novakov" target="_blank">@alexey_novakov</a><i class="fab fa-twitter" ></i></li>
    
    
    
    
    <li class="button extra_small font_faint"><a href="https://www.linkedin.com/in/alexey-novakov-26468624" target="_blank">alexey-novakov-26468624</a><i class="fab fa-linkedin" ></i></li>
    
    
    
    
    
</ul>

        
      </footer>
    <script src="/livereload.js?port=1024&amp;mindelay=10"></script></body>
</html>
