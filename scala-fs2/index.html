<!DOCTYPE html>
<html lang="en">
    <head>
      
        <meta http-equiv="X-UA-Compatible" content="IE=edge" >
        <meta http-equiv="content-type" content="text/html; charset=utf-8">   
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@alexey_novakov">
        <meta name="twitter:creator" content="@alexey_novakov">
        <meta name="twitter:url" content="https://novakov-alexey.github.io">
        <meta name="twitter:title" content="SE Notes - Alexey Novakov">
        <meta name="twitter:description" content="Software Engineering notes on Scala, JVM, Rust, Cloud and other goodies">
        <meta name="twitter:image" content="https://novakov-alexey.github.io/img/alexey_white2.jpg">
        <meta name="twitter:image:alt" content="Alexey Novakov photo for personal web-site">

        <!-- SEO -->
        
        <title> Scala FS2 - handle broken CSV lines | Software Engineering Notes </title>
        

        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport"  content="width=device-width, initial-scale=1.0, maximum-scale=1" >

        <!--  css -->
        <link rel="stylesheet"  href="https:&#x2F;&#x2F;novakov-alexey.github.io/ergo.css" >

        <!-- fonts -->
        <!-- preload  -->
        <link rel="preload" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway" as="style">
        <link rel="preload"  href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" as="style" >
        <!-- load -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"  integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
      
    </head>

    <body>
      
        
<input type="checkbox" id="openSidebarMenu" class="openSidebarMenu">
<label class="menu cross menu--1" for="openSidebarMenu">
    <svg viewBox="0 0 75 75" xmlns="https://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="30" />
        <path class="line--1" d="M0 40h62c13 0 6 28-4 18L35 35" />
        <path class="line--2" d="M0 50h70" />
        <path class="line--3" d="M0 60h62c13 0 6-28-4-18L35 65" />
    </svg>
</label>

<div id="sidebarMenu">
    <div class="menu_wrapper">
        <ul class="sidebarMenuInner" >     
            <li>
                <a href="https:&#x2F;&#x2F;novakov-alexey.github.io" >Software Engineering Notes</a>
                <div class="menu_div" ></div>
            </li>                   
            <li><a href="https:&#x2F;&#x2F;novakov-alexey.github.io/cv/">CV</a></li>
            <li><a href="https:&#x2F;&#x2F;novakov-alexey.github.io/presentations">Presentations</a></li>
            <li><a href="https:&#x2F;&#x2F;novakov-alexey.github.io/categories">Categories</a></li>
            <li><a href="https:&#x2F;&#x2F;novakov-alexey.github.io/tags">Tags</a></li>
        </ul>
    </div>
</div>

      

      
<nav id="overlord" class="overlord" >
  
<figure class="mini_logo ">
    <a href="https:&#x2F;&#x2F;novakov-alexey.github.io" style="background-image: url(https:&#x2F;&#x2F;novakov-alexey.github.io/img/alexey_white2.jpg)"></a>
</figure>
<h5>
    <a href="https:&#x2F;&#x2F;novakov-alexey.github.io">Software Engineering Notes</a>
</h5>

</nav>

<section class="post_container">
  <article>
    
      <h1 class="article_title"><a href="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;scala-fs2&#x2F;" id="article_link">Scala FS2 - handle broken CSV lines</a></h1>
      
<ul class="frontmatter frontmatter_page" id="frontmatter">
    <li>
        <time class="article_time"  datetime="2020-02-27">February 27, 2020</time>
    </li>
    <span class="dotDivider"></span>
    <li> 1101 words </li>
    <span class="dotDivider" ></span>
    <li> 6 min </li>
</ul>

      
      <div class="post-toc" id="post-toc">
          <h3 class="post-toc-title">Contents</h3>
          <div class="post-toc-content always-active">
              <nav id="TableOfContents">
                  <ul>
                      
                      <li>
                          <a href="https://novakov-alexey.github.io/scala-fs2/#scan-function" class="toc-link">Scan function</a>
                          
                      </li>
                      
                      <li>
                          <a href="https://novakov-alexey.github.io/scala-fs2/#csv-file-processing-using-fs2" class="toc-link">CSV file processing using FS2</a>
                          
                      </li>
                      
                      <li>
                          <a href="https://novakov-alexey.github.io/scala-fs2/#test-of-the-fs2-code" class="toc-link">Test of the FS2 code</a>
                          
                      </li>
                      
                      <li>
                          <a href="https://novakov-alexey.github.io/scala-fs2/#summary" class="toc-link">Summary</a>
                          
                      </li>
                      
                  </ul>
              </nav>
          </div>
      </div>
            
      <p>Recently, I ran into a familiar situation by doing data processing, where I needed to deal with a fragmented data stream. Having fragments, I had to detect manually where exactly new line/message starts and where current line/message ends in the stream. As turned out, one can aggregate intermediate state of the fragmented stream using scan function.</p>
<p>Let us dig down into how scan function is working.</p>
<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;7445a2d5c821903f00.jpg" />
<h2 id="scan-function">Scan function</h2>
<p>FS2 Stream Scan combinator works similar to scan function in Scala collection library. Official Scala doc for scan:</p>
<pre style="background-color:#282a36;">
<code><span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">scan</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">B </span><span style="color:#ff79c6;">&gt;: </span><span style="font-style:italic;color:#66d9ef;">A</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">That</span><span style="color:#f8f8f2;">](</span><span style="font-style:italic;color:#ffb86c;">z</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">B</span><span style="color:#f8f8f2;">)(</span><span style="font-style:italic;color:#ffb86c;">op</span><span style="color:#f8f8f2;">: (</span><span style="font-style:italic;color:#66d9ef;">B</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">B</span><span style="color:#f8f8f2;">) </span><span style="color:#ff79c6;">⇒ </span><span style="font-style:italic;color:#66d9ef;">B</span><span style="color:#f8f8f2;">)(
    </span><span style="color:#ff79c6;">implicit </span><span style="font-style:italic;color:#ffb86c;">cbf</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">CanBuildFrom</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">List</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">A</span><span style="color:#f8f8f2;">], </span><span style="font-style:italic;color:#66d9ef;">B</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">That</span><span style="color:#f8f8f2;">]
): </span><span style="font-style:italic;color:#66d9ef;">That
</span></code></pre>
<p>says:</p>
<blockquote>
  Computes a prefix scan of the elements of the collection.<br />
  
  -- Scala doc
  
</blockquote>
<p>Hm, what this would mean? It is much easier to try it and see how it works.</p>
<p>Here is <a href="https://superruzafa.github.io/visual-scala-reference/scanLeft">visual diagram</a> for scan:
<img src="/img/blog/scanLeft.svg"></p>
<p>Let’s try with simple List using Scala REPL.</p>
<ol>
<li>If we just aggregate and return acc every time in op function:</li>
</ol>
<pre style="background-color:#282a36;">
<code><span style="color:#f8f8f2;">&gt; </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#ffffff;">l </span><span style="color:#ff79c6;">= </span><span style="color:#6be5fd;">List</span><span style="color:#f8f8f2;">(</span><span style="color:#f1fa8c;">&quot;I&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;am&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;broken&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;sentence&quot;</span><span style="color:#f8f8f2;">)
l: </span><span style="font-style:italic;color:#66d9ef;">List</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= </span><span style="color:#6be5fd;">List</span><span style="color:#f8f8f2;">(</span><span style="color:#f1fa8c;">&quot;I&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;am&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;broken&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;sentence&quot;</span><span style="color:#f8f8f2;">

&gt; l</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">scan(</span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">)</span><span style="color:#ffffff;">{</span><span style="color:#ff79c6;">case </span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">acc</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#ffb86c;">e</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;"> acc + </span><span style="color:#f1fa8c;">&quot; &quot;</span><span style="color:#f8f8f2;"> +  e</span><span style="color:#ffffff;">}</span><span style="color:#f8f8f2;">
res5: </span><span style="font-style:italic;color:#66d9ef;">List</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= 
</span><span style="color:#6be5fd;">List</span><span style="color:#f8f8f2;">(</span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot; I&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot; I am&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot; I am broken&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot; I am broken sentence&quot;</span><span style="color:#f8f8f2;">)
</span></code></pre>
<ol start="2">
<li>If we apply some if condition based on the element content, then we can control, which element is going to be added into output collection:</li>
</ol>
<pre style="background-color:#282a36;">
<code><span style="color:#f8f8f2;">&gt; l</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">scan(</span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">)</span><span style="color:#ffffff;">{
  </span><span style="color:#ff79c6;">case </span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">acc</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#ffb86c;">e</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt; </span><span style="color:#ff79c6;">if </span><span style="color:#f8f8f2;">(e </span><span style="color:#ff79c6;">== </span><span style="color:#f1fa8c;">&quot;broken&quot;</span><span style="color:#f8f8f2;">) e </span><span style="color:#ff79c6;">else</span><span style="color:#f8f8f2;">  acc + </span><span style="color:#f1fa8c;">&quot; &quot;</span><span style="color:#f8f8f2;"> +  e
</span><span style="color:#ffffff;">}</span><span style="color:#f8f8f2;">

res6: </span><span style="font-style:italic;color:#66d9ef;">List</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= 
</span><span style="color:#6be5fd;">List</span><span style="color:#f8f8f2;">(</span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot; I&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot; I am&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;broken&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;broken sentence&quot;</span><span style="color:#f8f8f2;">)
</span></code></pre>
<p>As we can see, once boolean condition in the if is true, we return only the current element e and start new accumulation, i.e. produce next element without all the stuff we accumulated before. Hopefully, these two examples help to grasp an idea of the scan function.</p>
<h2 id="csv-file-processing-using-fs2">CSV file processing using FS2</h2>
<p>Let’s first create a Scala IOApp using cats-effect library, which is coming as FS2 dependency, and define FS2 blocking execution context to work with files.</p>
<pre style="background-color:#282a36;">
<code><span style="color:#ff79c6;">import</span><span style="color:#f8f8f2;"> java</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">nio</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">file</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">Paths
</span><span style="color:#ff79c6;">import</span><span style="color:#f8f8f2;"> java</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">util</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">concurrent</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">Executors
</span><span style="color:#ff79c6;">import</span><span style="color:#f8f8f2;"> cats</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">effect</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">{ExitCode, IO, IOApp, Resource}
</span><span style="color:#ff79c6;">import</span><span style="color:#f8f8f2;"> cats</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">instances</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">int</span><span style="color:#ff79c6;">.</span><span style="color:#bd93f9;">_
</span><span style="color:#ff79c6;">import</span><span style="color:#f8f8f2;"> cats</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">syntax</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">all</span><span style="color:#ff79c6;">.</span><span style="color:#bd93f9;">_
</span><span style="color:#ff79c6;">import</span><span style="color:#f8f8f2;"> fs2</span><span style="color:#ff79c6;">.</span><span style="color:#bd93f9;">_

</span><span style="font-style:italic;color:#ff79c6;">object</span><span style="text-decoration:underline;color:#8be9fd;"> Main </span><span style="color:#ff79c6;">extends </span><span style="text-decoration:underline;font-style:italic;color:#8be9fd;">IOApp </span><span style="color:#f8f8f2;">{
  </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#ffffff;">Separator </span><span style="color:#ff79c6;">= </span><span style="color:#f1fa8c;">&quot;;&quot;
  </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#ffffff;">isNextId</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">Regex </span><span style="color:#ff79c6;">= </span><span style="color:#8be9fd;">s</span><span style="color:#f1fa8c;">&quot;^(</span><span style="color:#ff79c6;">\\</span><span style="color:#f1fa8c;">s*</span><span style="color:#ff79c6;">\\</span><span style="color:#f1fa8c;">d+.*)</span><span style="color:#ffffff;">$Separator</span><span style="color:#f1fa8c;">&quot;</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">r
  </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#ffffff;">LastRowPaddingId </span><span style="color:#ff79c6;">= </span><span style="color:#8be9fd;">s</span><span style="color:#f1fa8c;">&quot;1</span><span style="color:#ffffff;">$Separator</span><span style="color:#f1fa8c;">&quot;
  </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#ffffff;">ColumnsInFile </span><span style="color:#ff79c6;">= </span><span style="color:#bd93f9;">10
  </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#ffffff;">HeaderLines </span><span style="color:#ff79c6;">= </span><span style="color:#bd93f9;">1  
  
  </span><span style="color:#ff79c6;">override </span><span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">run</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">args</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">List</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">]): </span><span style="font-style:italic;color:#66d9ef;">IO</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">ExitCode</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;">
    processFile(</span><span style="color:#f1fa8c;">&quot;./input.csv&quot;</span><span style="color:#f8f8f2;">)</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">compile</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">drain</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">as(</span><span style="color:#6be5fd;">ExitCode</span><span style="color:#ff79c6;">.</span><span style="color:#6be5fd;">Success</span><span style="color:#f8f8f2;">)  
    
  </span><span style="color:#ff79c6;">private </span><span style="font-style:italic;color:#8be9fd;">val </span><span style="color:#ffffff;">blockingExecutionContext </span><span style="color:#ff79c6;">=
    </span><span style="color:#6be5fd;">Resource</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">make(</span><span style="color:#6be5fd;">IO</span><span style="color:#f8f8f2;">(
        </span><span style="color:#6be5fd;">ExecutionContext
          </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">fromExecutorService(</span><span style="color:#6be5fd;">Executors</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">newFixedThreadPool(</span><span style="color:#bd93f9;">2</span><span style="color:#f8f8f2;">))
        ))(</span><span style="font-style:italic;color:#ffb86c;">ec </span><span style="font-style:italic;color:#8be9fd;">=&gt; </span><span style="color:#6be5fd;">IO</span><span style="color:#f8f8f2;">(ec</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">shutdown()))  
        
  </span><span style="color:#ff79c6;">private </span><span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">processFile</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">filePath</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">): </span><span style="font-style:italic;color:#66d9ef;">Stream</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">IO</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#8be9fd;">Unit</span><span style="color:#f8f8f2;">] </span><span style="color:#ff79c6;">= ???
</span><span style="color:#f8f8f2;">}
</span></code></pre>
<p>Above <strong>processFile</strong> function will be returning a stream taking a file path to be processed as CSV file.</p>
<p><strong>processFile</strong> implementation:</p>
<pre style="background-color:#282a36;">
<code><span style="color:#6be5fd;">Stream</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">resource(blockingExecutionContext)</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">flatMap </span><span style="color:#ffffff;">{ </span><span style="font-style:italic;color:#ffb86c;">blockingEC </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;">
  io</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">file
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">readAll[</span><span style="font-style:italic;color:#66d9ef;">IO</span><span style="color:#f8f8f2;">](</span><span style="color:#6be5fd;">Paths</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">get(filePath), blockingEC, </span><span style="color:#bd93f9;">4</span><span style="color:#f8f8f2;"> * </span><span style="color:#bd93f9;">4096</span><span style="color:#f8f8f2;">)
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">through(text</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">utf8Decode)
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">append(</span><span style="color:#6be5fd;">Stream</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">eval(</span><span style="color:#6be5fd;">IO</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">pure(</span><span style="color:#f1fa8c;">&quot;</span><span style="color:#ff79c6;">\n</span><span style="color:#f1fa8c;">&quot;</span><span style="color:#f8f8f2;"> + </span><span style="color:#6be5fd;">LastRowPaddingId</span><span style="color:#f8f8f2;">)))
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">through(text</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">lines)
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">drop(</span><span style="color:#6be5fd;">HeaderLines</span><span style="color:#f8f8f2;">)
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">scan((</span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">)) </span><span style="color:#ffffff;">{
      </span><span style="color:#ff79c6;">case </span><span style="color:#f8f8f2;">((</span><span style="font-style:italic;color:#ffb86c;">acc</span><span style="color:#f8f8f2;">, </span><span style="color:#bd93f9;">_</span><span style="color:#f8f8f2;">), </span><span style="font-style:italic;color:#ffb86c;">line</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;"> concatBrokenLines(acc, line)
    </span><span style="color:#ffffff;">}
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">filter </span><span style="color:#ffffff;">{ </span><span style="color:#ff79c6;">case </span><span style="color:#f8f8f2;">(</span><span style="color:#bd93f9;">_</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#ffb86c;">line</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;"> line</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">trim</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">nonEmpty </span><span style="color:#ffffff;">}
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">map </span><span style="color:#ffffff;">{ </span><span style="color:#ff79c6;">case </span><span style="color:#f8f8f2;">(</span><span style="color:#bd93f9;">_</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#ffb86c;">line</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;"> line</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">split(</span><span style="color:#6be5fd;">Separator</span><span style="color:#f8f8f2;">, </span><span style="color:#6be5fd;">ColumnsInFile</span><span style="color:#f8f8f2;">) </span><span style="color:#ffffff;">}
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">map(processRow)
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">foldMap(</span><span style="color:#bd93f9;">_ </span><span style="font-style:italic;color:#8be9fd;">=&gt; </span><span style="color:#bd93f9;">1</span><span style="color:#f8f8f2;">)
    </span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">map(</span><span style="font-style:italic;color:#ffb86c;">n </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;"> println(</span><span style="color:#8be9fd;">s</span><span style="color:#f1fa8c;">&quot;Processed </span><span style="color:#ffffff;">$n</span><span style="color:#f1fa8c;"> record(s)&quot;</span><span style="color:#f8f8f2;">))
</span><span style="color:#ffffff;">}
</span></code></pre>
<p>The main code of finding the complete CSV line (a line, which can have multiple parts of one logical CSV line separated by line brakes like \n) starts at line:</p>
<pre style="background-color:#282a36;">
<code><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">scan((</span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">, </span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">)) </span><span style="color:#ffffff;">{
  </span><span style="color:#ff79c6;">case </span><span style="color:#f8f8f2;">((</span><span style="font-style:italic;color:#ffb86c;">acc</span><span style="color:#f8f8f2;">, </span><span style="color:#bd93f9;">_</span><span style="color:#f8f8f2;">), </span><span style="font-style:italic;color:#ffb86c;">line</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;"> concatBrokenLines(acc, line)
</span><span style="color:#ffffff;">}
</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">filter </span><span style="color:#ffffff;">{ </span><span style="color:#ff79c6;">case </span><span style="color:#f8f8f2;">(</span><span style="color:#bd93f9;">_</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#ffb86c;">line</span><span style="color:#f8f8f2;">) </span><span style="font-style:italic;color:#8be9fd;">=&gt;</span><span style="color:#f8f8f2;"> line</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">trim</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">nonEmpty </span><span style="color:#ffffff;">}
</span></code></pre>
<p>Inside the scan function, we delegate ‘op’ part to concatBrokenLine function:</p>
<pre style="background-color:#282a36;">
<code><span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">concatBrokenLines</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">acc</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#ffb86c;">line</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">) </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">{  
  </span><span style="color:#6272a4;">// next line detected, i.e. we flush `acc` downstream,
  // since it already contains a complete line to be processed
  </span><span style="color:#ff79c6;">if </span><span style="color:#f8f8f2;">(isNextId</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">findFirstIn(acc)</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">isDefined 
      &amp;&amp; isNextId</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">findFirstIn(line)</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">isDefined) (line, acc)
  
  </span><span style="color:#6272a4;">// next line is not yet detected, i.e. we flush an empty string 
  // and append current line to the current `acc` state  
  </span><span style="color:#ff79c6;">else </span><span style="color:#f8f8f2;">(acc + </span><span style="color:#f1fa8c;">&quot; &quot;</span><span style="color:#f8f8f2;"> + line, </span><span style="color:#f1fa8c;">&quot;&quot;</span><span style="color:#f8f8f2;">)
</span><span style="color:#ffffff;">}
</span></code></pre>
<p>using regular expression <strong>isNextId</strong> we identify, whether new line marker is found. In the regular expression we want to find a number following by semicolon (according to current file business logic).</p>
<p>Read the inline comments in the <em>concatBrokenLines</em> function on how using if/else logic, we control what needs to be put into next element of the downstream. As you can see, we use second half of the accumulator to push the complete line further (in the if branch).</p>
<p><strong>Now looking at scan and its concatBrokenLines function together</strong>, we can summarise:</p>
<p>we process CSV lines by folding them via scan function using empty element as a tuple of two empty strings (“”, “”). In the head of the scanning lambda we use only first part of the zero element, we call it acc, i.e. accumulator. We also have <strong>line</strong> variable, which is given by the Stream.scan function itself. Then, we delegate the decision on what needs to be returned to the downstream using <em>filter</em> function. Basically, we use <em>filter</em> as a guard to control what actually needs to be passed further for the main processing logic as CVS line.</p>
<p>Also, we append fake line to be able to process the very last line. This last line needs one more marker to be properly detected as complete line:</p>
<pre style="background-color:#282a36;">
<code><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">append(</span><span style="color:#6be5fd;">Stream</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">eval(</span><span style="color:#6be5fd;">IO</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">pure(</span><span style="color:#f1fa8c;">&quot;</span><span style="color:#ff79c6;">\n</span><span style="color:#f1fa8c;">&quot;</span><span style="color:#f8f8f2;"> + </span><span style="color:#6be5fd;">LastRowPaddingId</span><span style="color:#f8f8f2;">)))
</span></code></pre><h2 id="test-of-the-fs2-code">Test of the FS2 code</h2>
<p>Using file input.csv:</p>
<pre style="background-color:#282a36;">
<code><span style="color:#f8f8f2;">index;City;population
1;Berlin is the
capital and largest city of
Germany by
both area and population.;3,748,148
1;Madrid is the capital of Spain and the largest
municipality in both the Community of Madrid and Spain as
a whole.;3,223,334
1;Donetsk former names: Aleksandrovka,
Hughesovka, Yuzovka, Stalino is an industrial city in Ukraine on the Kalmius
River.;929,063
</span></code></pre>
<p>we print the resulted lines of the stream in the <em>processRow</em> function. In real life this function supposed to do something useful:</p>
<pre style="background-color:#282a36;">
<code><span style="color:#ff79c6;">private </span><span style="font-style:italic;color:#8be9fd;">def </span><span style="color:#50fa7b;">processRow</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#ffb86c;">columns</span><span style="color:#f8f8f2;">: </span><span style="font-style:italic;color:#66d9ef;">Array</span><span style="color:#f8f8f2;">[</span><span style="font-style:italic;color:#66d9ef;">String</span><span style="color:#f8f8f2;">]): </span><span style="font-style:italic;color:#8be9fd;">Unit </span><span style="color:#ff79c6;">=</span><span style="color:#f8f8f2;"> 
  println(</span><span style="color:#8be9fd;">s</span><span style="color:#f1fa8c;">&quot;processed: ${</span><span style="color:#f8f8f2;">columns</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">mkString(</span><span style="color:#f1fa8c;">&quot; :: &quot;</span><span style="color:#f8f8f2;">)</span><span style="color:#ff79c6;">.</span><span style="color:#f8f8f2;">trim</span><span style="color:#f1fa8c;">}&quot;</span><span style="color:#f8f8f2;">)
</span></code></pre>
<p>Output:</p>
<pre style="background-color:#282a36;">
<code><span style="color:#f8f8f2;">processed: 1 :: Berlin is the capital and largest city of Germany by both area and population. :: 3,748,148
processed: 1 :: Madrid is the capital of Spain and the largest municipality in both the Community of Madrid and Spain as a whole. :: 3,223,334
processed: 1 :: Donetsk former names: Aleksandrovka, Hughesovka, Yuzovka, Stalino is an industrial city in Ukraine on the Kalmius River. :: 929,063
Processed 3 record(s)
</span></code></pre><h2 id="summary">Summary</h2>
<p>Applying knowledge of functional combinators, we have gotten concise and clean code, without using any global mutable state outside of the stream definition. We have also solved the problem within the single data stream using scan to aggregate intermediate state and filter function as a guard to discard incomplete CSV lines.</p>
<p>FS2 library is very nice and especially having Cats and Cats-effect as direct dependency. 
See more examples for functional streaming in <a href="https://fs2.io/guide.html">FS2 guide</a></p>
<p>Source code: <a href="https://github.com/novakov-alexey/fs2-csv-scan">https://github.com/novakov-alexey/fs2-csv-scan</a></p>

      
  </article>
</section>

       

      <footer>
        
          
<figure class="mini_logo ">
    <a href="https:&#x2F;&#x2F;novakov-alexey.github.io" style="background-image: url(https:&#x2F;&#x2F;novakov-alexey.github.io/img/alexey_white2.jpg)"></a>
</figure>
<h5>
    <a href="https:&#x2F;&#x2F;novakov-alexey.github.io">Software Engineering Notes</a>
</h5>

          
<ul class="social_list foot_list" >
    
    
    <li class="button extra_small font_faint"><a href="https://github.com/novakov-alexey" target="_blank" >novakov-alexey</a><i class="fab fa-github" ></i></li>
    
    
    <li class="button extra_small font_faint"><a href="https://twitter.com/alexey_novakov" target="_blank">@alexey_novakov</a><i class="fab fa-twitter" ></i></li>
    
    
    
    
    <li class="button extra_small font_faint"><a href="https://www.linkedin.com/in/alexey-novakov-26468624" target="_blank">alexey-novakov-26468624</a><i class="fab fa-linkedin" ></i></li>
    
    
    
    
    <!-- 
    <li class="button extra_small font_faint"><a href="https:&#x2F;&#x2F;novakov-alexey.github.io/rss.xml" target ="_blank">rss</a><i class="fas fa-rss" ></i></li>
     -->
</ul>

        
      </footer>
    </body>
</html>
